.. _amd_pk:

========
AMD - PK
========

WRITE A FEW LINES OF DESCRIPTION HERE
- What kind of model
- What kind of input

~~~~~~~
Running
~~~~~~~

The code to initiate the AMD tool for a PK model:

.. pharmpy-code::

    from pharmpy.tools import run_amd

    dataset_path = 'path/to/dataset'
    strategy = 'default'
    res = run_amd(input=dataset_path,
                  modeltype='basic_pk',
                  administration='oral',
                  strategy=strategy,
                  search_space='LET(CATEGORICAL, [SEX]); LET(CONTINUOUS, [AGE])',
                  allometric_variable='WGT',
                  occasion='VISI')

Arguments
~~~~~~~~~
The arguments used in PK models are the following

WRITE SOMETHING ABOUT INPUT

Mandatory
---------

+-------------------------------------------------+-----------------------------------------------------------------------------------------+
| Argument                                        | Description                                                                             |
+=================================================+=========================================================================================+
| ``modeltype``                                   | Type of model. In this case "basic_pk".                                                 |
+-------------------------------------------------+-----------------------------------------------------------------------------------------+

Optional
--------

+-------------------------------------------------+-----------------------------------------------------------------------------------------+
| Argument                                        | Description                                                                             |
+=================================================+=========================================================================================+
| ``cl_init``                                     | Initial estimate for the population clearance (default is 0.01)                         |
+-------------------------------------------------+-----------------------------------------------------------------------------------------+


.. _models:

~~~~~~~~~~~~~~
Strategy parts
~~~~~~~~~~~~~~

Refer to AMD strategy explanation to see how the different parts are connected

Structural
~~~~~~~~~~

Structural covariates
=====================

The structural covariates are added directly to the starting model. If these cannot be added here (due to missing 
parameters for instance) they will be tested once more at the start of the next covsearch run.

Modelsearch
===========

The settings that the AMD tool uses for the modelsearch subtool can be seen in the table below.

+---------------+----------------------------------------------------------------------------------------------------+
| Argument      | Setting                                                                                            |
+===============+====================================================================================================+
| search_space  | Given in :ref:`AMD options<amd_args>` (``search_space``)                                           |
+---------------+----------------------------------------------------------------------------------------------------+
| algorithm     | ``'reduced_stepwise'``                                                                             |
+---------------+----------------------------------------------------------------------------------------------------+
| iiv_strategy  | ``'absorption_delay'``                                                                             |
+---------------+----------------------------------------------------------------------------------------------------+
| rank_type     | ``'bic'`` (type: mixed)                                                                            |
+---------------+----------------------------------------------------------------------------------------------------+
| cutoff        | ``None``                                                                                           |
+---------------+----------------------------------------------------------------------------------------------------+

IIVSearch
~~~~~~~~~

The settings that the AMD tool uses for this subtool can be seen in the table below.

+---------------+---------------------------+------------------------------------------------------------------------+
| Argument      | Setting                   |   Setting (rerun)                                                      |
+===============+===========================+========================================================================+
| algorithm     | ``'brute_force'``         |  ``'brute_force'``                                                     |
+---------------+---------------------------+------------------------------------------------------------------------+
| iiv_strategy  | ``'fullblock'``           |  ``'no_add'``                                                          |
+---------------+---------------------------+------------------------------------------------------------------------+
| rank_type     | ``'bic'`` (type: iiv)     |  ``'bic'`` (type: iiv)                                                 |
+---------------+---------------------------+------------------------------------------------------------------------+
| cutoff        | ``None``                  |  ``None``                                                              |
+---------------+---------------------------+------------------------------------------------------------------------+

Residual
~~~~~~~~

The settings that the AMD tool uses for this subtool can be seen in the table below. When re-running the tool, the
settings remain the same.

+---------------+----------------------------------------------------------------------------------------------------+
| Argument      | Setting                                                                                            |
+===============+====================================================================================================+
| groups        | ``4``                                                                                              |
+---------------+----------------------------------------------------------------------------------------------------+
| p_value       | ``0.05``                                                                                           |
+---------------+----------------------------------------------------------------------------------------------------+
| skip          | ``None``                                                                                           |
+---------------+----------------------------------------------------------------------------------------------------+

IOVSearch
~~~~~~~~~

The settings that the AMD tool uses for this subtool can be seen in the table below. 

+---------------------+----------------------------------------------------------------------------------------------+
| Argument            | Setting                                                                                      |
+=====================+==============================================================================================+
| column              | Given in :ref:`AMD options<amd_args>` (``occasion``)                                         |
+---------------------+----------------------------------------------------------------------------------------------+
| list_of_parameters  | ``None``                                                                                     |
+---------------------+----------------------------------------------------------------------------------------------+
| rank_type           | ``'bic'`` (type: random)                                                                     |
+---------------------+----------------------------------------------------------------------------------------------+
| cutoff              | ``None``                                                                                     |
+---------------------+----------------------------------------------------------------------------------------------+
| distribution        | ``'same-as-iiv'``                                                                            |
+---------------------+----------------------------------------------------------------------------------------------+

Allometry
~~~~~~~~~

The settings that the AMD tool uses for this subtool can be seen in the table below.

+----------------------+---------------------------------------------------------------------------------------------+
| Argument             | Setting                                                                                     |
+======================+=============================================================================================+
| allometric_variable  | Given in :ref:`AMD options<amd_args>` (``allometric_variable``)                             |
+----------------------+---------------------------------------------------------------------------------------------+
| reference_value      | ``70``                                                                                      |
+----------------------+---------------------------------------------------------------------------------------------+
| parameters           | ``None``                                                                                    |
+----------------------+---------------------------------------------------------------------------------------------+
| initials             | ``None``                                                                                    |
+----------------------+---------------------------------------------------------------------------------------------+
| lower_bounds         | ``None``                                                                                    |
+----------------------+---------------------------------------------------------------------------------------------+
| upper_bounds         | ``None``                                                                                    |
+----------------------+---------------------------------------------------------------------------------------------+
| fixed                | ``None``                                                                                    |
+----------------------+---------------------------------------------------------------------------------------------+

COVSearch
~~~~~~~~~

The settings that the AMD tool uses for this subtool can be seen in the table below. 

+---------------+----------------------------------------------------------------------------------------------------+
| Argument      | Setting                                                                                            |
+===============+====================================================================================================+
| effects       | Given in :ref:`AMD options<amd_args>` (``search_space``)                                           |
+---------------+----------------------------------------------------------------------------------------------------+
| p_forward     | ``0.05``                                                                                           |
+---------------+----------------------------------------------------------------------------------------------------+
| p_backward    | ``0.01``                                                                                           |
+---------------+----------------------------------------------------------------------------------------------------+
| max_steps     | ``-1``                                                                                             |
+---------------+----------------------------------------------------------------------------------------------------+
| algorithm     | ``'scm-forward-then-backward'``                                                                    |
+---------------+----------------------------------------------------------------------------------------------------+

Mechanisitic covariates
=======================

If any mechanistic covariates have been given as input to the AMD tool, the specified covariate effects for these
covariates is run in a separate initial covsearch run when adding covariates.

Exploratory covariates
======================

The remaining covariates are tested after all mechanistic covariates have been tested.

~~~~~~~~
Examples
~~~~~~~~

A minimum example for running AMD with modeltype PK:

.. pharmpy-code::

    from pharmpy.tools import run_amd

    start_model = read_model('path/to/model')

    res = run_amd(
                modeltype='basic_pk',
                input=start_model,
                search_space='ABSORPTION(FO)',
                )

Specifying initial parameters:

.. pharmpy-code::

    from pharmpy.tools import run_amd

    start_model = read_model('path/to/model')

    res = run_amd(
                modeltype='basic_pk',
                input=start_model,
                search_space='ABSORPTION(FO)',
                cl_init=2.0,
                vc_init=5.0,
                )

